<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹è®­è¥ - æˆ˜åœºæŒ‡æŒ¥ä¸­å¿ƒ (æ‚¬å¿µç»ˆå±€ç‰ˆ)</title>
    <style>
        :root {
            --bg: #050a12; --card: #121a25; 
            --c-bronze: #cd7f32; --c-silver: #bdc3c7; --c-gold: #f9d423;
            --c-platinum: #00ced1; --c-challenger: #ff3f34;
            --lol-blue: #00d2ff; --text-main: #e6edf3;
            --btn-off: #1e2328; --btn-border: #3c3c41;
            --danger: #e74c3c;
        }
        
        body { background: var(--bg); color: var(--text-main); font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; margin: 0; user-select: none; overflow-x: hidden; }
        
        /* å¯åŠ¨é®ç½©å±‚ */
        #init-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(5, 10, 18, 0.95); z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; backdrop-filter: blur(5px);
        }
        #init-overlay h1 { font-size: 3rem; color: #f9d423; text-shadow: 0 0 20px #e67e22; animation: pulse 1s infinite; }
        #init-overlay p { color: #aaa; margin-top: 20px; font-size: 1.2rem; }

        /* é¡¶éƒ¨æ  */
        .header-controls {
            background: rgba(18, 26, 37, 0.95); border-bottom: 2px solid #30363d;
            padding: 10px 20px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .title-group { display: flex; align-items: center; gap: 15px; }
        .title-group h1 { margin: 0; font-size: 1.1rem; color: var(--lol-blue); text-transform: uppercase; letter-spacing: 1px; }
        
        /* æŒ‰é’®ç»„ */
        .header-btns { display: flex; gap: 8px; }

        .btn-common { padding: 6px 12px; border-radius: 50px; cursor: pointer; font-weight: 900; font-size: 0.85rem; display: flex; align-items: center; gap: 4px; border: 2px solid; transition: transform 0.2s; }
        .btn-common:hover { transform: scale(1.05); filter: brightness(1.1); }
        .btn-common:active { transform: scale(0.95); }

        .btn-battle { background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%); border-color: #ff4757; color: white; animation: pulse-red 2s infinite; }
        .btn-mvp { background: linear-gradient(135deg, #f9d423 0%, #e67e22 100%); border-color: #f9d423; color: #000; }
        
        /* æœ¬æ—¥å† å†› - ç»¿è‰²ç³» */
        .btn-day-mvp { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-color: #2ecc71; color: white; display: none; }
        
        /* æ€»å†³èµ› FMVP - ç´«è‰²å¸ç‹ç³» */
        .btn-grand-fmvp { background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); border-color: #a55eea; color: white; display: none; box-shadow: 0 0 15px #a55eea; }

        .btn-refresh { background: #34495e; border-color: #7f8c8d; color: white; margin-left: 10px; }

        .control-group { display: flex; gap: 10px; align-items: center; }
        select.selector { background: #1e2328; color: #f9d423; border: 1px solid #f9d423; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        button.btn-add { background: linear-gradient(45deg, #00d2ff, #3a7bd5); border: none; color: white; padding: 6px 15px; border-radius: 50px; cursor: pointer; font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 20px; padding: 20px; }
        .card { background: var(--card); border-radius: 10px; padding: 15px; display: flex; flex-direction: column; gap: 12px; border: 2px solid #30363d; transition: all 0.3s ease; position: relative; overflow: hidden; }
        
        /* æ®µä½è¾¹æ¡† */
        .rank-bronze { border-color: var(--c-bronze); }
        .rank-silver { border-color: var(--c-silver); }
        .rank-gold { border-color: var(--c-gold); box-shadow: 0 0 10px rgba(249, 212, 35, 0.1); }
        .rank-platinum { border-color: var(--c-platinum); box-shadow: 0 0 10px rgba(0, 206, 209, 0.2); }
        .rank-challenger { border: 3px solid transparent; background-image: linear-gradient(var(--card), var(--card)), linear-gradient(45deg, #ff3f34, #f9d423); background-origin: border-box; background-clip: content-box, border-box; box-shadow: 0 0 15px rgba(255, 63, 52, 0.3); }

        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #0b1016; border: 2px solid #444; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .rank-challenger .avatar { border-color: #ff3f34; color: #f9d423; }
        .score-badge { text-align: right; }
        .total-at { font-size: 1.4rem; font-weight: 900; color: var(--c-gold); line-height: 1; }
        .sub-score { font-size: 0.75rem; color: #666; }

        .auto-eval-bar { background: #0b1016; padding: 8px 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #30363d; }
        .eval-left { font-size: 0.8rem; color: #888; }
        .eval-right { font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .grade-S { color: #f9d423; text-shadow: 0 0 5px #e74c3c; animation: pulse 1s infinite; }
        .grade-A { color: #3498db; }
        .grade-B { color: #2ecc71; }
        .grade-C { color: #e67e22; }
        .grade-D { color: #7f8c8d; }

        .actions-area { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .skill-btn { background: var(--btn-off); border: 1px solid var(--btn-border); color: #888; padding: 10px; border-radius: 6px; cursor: pointer; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.1s; position: relative; }
        .skill-btn .label { font-size: 0.75rem; margin-bottom: 2px; }
        .skill-btn .value { font-size: 1rem; font-weight: bold; font-family: 'Segoe UI', sans-serif; }
        .skill-btn.active { background: rgba(0, 210, 255, 0.15); border-color: var(--lol-blue); color: var(--lol-blue); }
        .ask-btn.stage-1 { border-color: #f9d423; color: #f9d423; background: rgba(249, 212, 35, 0.1); }
        .ask-btn.stage-2 { border-color: #ff9f43; color: #ff9f43; background: rgba(255, 159, 67, 0.1); }
        .ask-btn.stage-3 { border-color: #ff3f34; color: #ff3f34; background: rgba(255, 63, 52, 0.1); }
        .feynman-btn { grid-column: span 2; border-color: #a55eea; }
        .feynman-btn.active { background: rgba(165, 94, 234, 0.2); color: #d2a4ff; border-color: #d2a4ff; }
        .punish-btn { grid-column: span 2; border-color: var(--danger); color: var(--danger); flex-direction: row; gap: 10px; margin-top: 5px; opacity: 0.7; }
        .punish-btn:hover { background: rgba(231, 76, 60, 0.1); opacity: 1; }
        .punish-btn:active { transform: scale(0.98); }
        .punish-val { font-weight: bold; font-size: 1.1rem; }

        .select-container { position: relative; background: var(--btn-off); border: 1px solid var(--btn-border); border-radius: 6px; overflow: hidden; }
        .select-container select { width: 100%; height: 100%; background: transparent; color: #888; border: none; padding: 10px; font-weight: bold; appearance: none; cursor: pointer; text-align: center; font-size: 0.9rem; }
        .select-container select:focus { outline: none; background: #2c3e50; }
        .select-container.has-value { border-color: var(--lol-blue); background: rgba(0, 210, 255, 0.1); }
        .select-container.has-value select { color: var(--lol-blue); }

        .progress-track { background: #000; height: 4px; border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.5s ease; }

        .danmu { position: fixed; white-space: nowrap; font-weight: 900; font-size: 2.5rem; text-shadow: 2px 2px 4px #000; z-index: 9999; pointer-events: none; animation: moveDanmu 8s linear forwards; font-family: 'Segoe UI', sans-serif; }
        @keyframes moveDanmu { from { left: 100%; transform: translateX(0); } to { left: -100%; transform: translateX(-100%); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

        #mvp-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 10001; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        #mvp-overlay.active { display: flex; animation: fadeIn 0.5s; }
        .mvp-title { font-size: 3rem; color: #f9d423; font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 20px #e67e22; letter-spacing: 5px; }
        .mvp-name { font-size: 5rem; color: #fff; font-weight: bold; margin-bottom: 10px; text-shadow: 5px 5px 0px #333; }
        .mvp-score { font-size: 2rem; color: var(--lol-blue); font-family: monospace; }
        .fmvp-streak-info { font-size: 1.5rem; color: #ff3f34; margin-top: 10px; font-weight: bold; letter-spacing: 2px; }
        .close-overlay { margin-top: 40px; padding: 10px 30px; border: 2px solid #fff; background: transparent; color: #fff; cursor: pointer; font-size: 1.2rem; border-radius: 30px; }
        .fmvp-style .mvp-title { color: #a55eea; text-shadow: 0 0 20px #8e44ad; }
        .fmvp-style .mvp-name { color: #ff3f34; text-shadow: 5px 5px 0px #000; animation: pulse 1s infinite; position: relative; }
        .fmvp-style .mvp-name::before { content: "ğŸ‘‘"; position: absolute; top: -60px; left: 50%; transform: translateX(-50%) rotate(-10deg); font-size: 4rem; filter: drop-shadow(0 0 10px gold); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="init-overlay" onclick="initSystem()">
    <h1>ç‚¹å‡»å±å¹•å¼€å¯æˆ˜åœº</h1>
    <p>Click to Initialize Audio System</p>
</div>

<audio id="audio-start" src="the-battle-has-begun.mp3" preload="auto"></audio>
<audio id="audio-minions" src="minions-have-spawned.mp3" preload="auto"></audio>
<audio id="audio-firstblood" src="league-of-legends-first-blood-sound.mp3" preload="auto"></audio>
<audio id="audio-doublekill" src="double-kill-lol.mp3" preload="auto"></audio>
<audio id="audio-triplekill" src="triple-kill-lol.mp3" preload="auto"></audio>

<audio id="snd-p1" src="a-summoner-has-disconnected.mp3" preload="auto"></audio>
<audio id="snd-p2" src="your-inhibitor-is-under-attack.mp3" preload="auto"></audio>
<audio id="snd-p3" src="mlbb-you-have-been-slain.mp3" preload="auto"></audio>
<audio id="snd-p4" src="defeat_90KWHvE.mp3" preload="auto"></audio>

<audio id="audio-victory" src="victory!-made-with-Voicemod.mp3" preload="auto"></audio>
<audio id="audio-legendary" src="legendary2_1.mp3" preload="auto"></audio>

<audio id="audio-fmvp-1" src="unstoppable.mp3" preload="auto"></audio>
<audio id="audio-fmvp-2" src="killing_spree.mp3" preload="auto"></audio>
<audio id="audio-fmvp-3" src="rampage.mp3" preload="auto"></audio>
<audio id="audio-fmvp-4" src="dominating.mp3" preload="auto"></audio>
<audio id="audio-fmvp-5" src="legendary2_1.mp3" preload="auto"></audio>

<audio id="audio-rankup" src="mastery-emote-tier-5.mp3" preload="auto"></audio>

<div id="mvp-overlay">
    <div id="mvp-title" class="mvp-title">MATCH MVP</div>
    <div id="mvp-name" class="mvp-name">å­¦å‘˜å§“å</div>
    <div id="mvp-score" class="mvp-score">SCORE: 0</div>
    <div id="fmvp-streak" class="fmvp-streak-info" style="display:none;"></div>
    <button class="close-overlay" onclick="document.getElementById('mvp-overlay').classList.remove('active')">å…³é—­ç»“ç®—</button>
</div>

<div class="header-controls">
    <div class="title-group">
        <h1>æˆ˜åœºæŒ‡æŒ¥ä¸­å¿ƒ</h1>
        <div class="header-btns">
            <button class="btn-common btn-battle" onclick="startBattle()"><span>âš”ï¸</span> å‡ºå‡»</button>
            
            <button class="btn-common btn-mvp" onclick="showLessonMVP()">ğŸ… æœ¬å ‚MVP</button>
            
            <button class="btn-common btn-day-mvp" onclick="showDailyMVP()">ğŸ“… æœ¬æ—¥å† å†›</button>
            
            <button class="btn-common btn-grand-fmvp" onclick="showGrandFMVP()">ğŸ† æ€»å†³èµ›FMVP</button>
        </div>
    </div>
    <div class="control-group">
        <select id="daySelect" class="selector" onchange="updateSchedule()">
            <option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option><option value="4">Day 4</option><option value="5">Day 5</option>
        </select>
        <select id="lessonSelect" class="selector" onchange="manualSortAndRender()">
            </select>
        <button class="btn-common btn-refresh" onclick="manualSortAndRender()">ğŸ”„ åˆ·æ–°æ’å</button>
        <button class="btn-add" onclick="addStudent()">+ å­¦å‘˜</button>
    </div>
</div>

<div class="grid" id="studentGrid"></div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
    // --- å¯åŠ¨è§£é”éŸ³é¢‘ ---
    function initSystem() {
        const overlay = document.getElementById('init-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => overlay.style.display = 'none', 500);
        document.querySelectorAll('audio').forEach(audio => {
            audio.muted = true;
            audio.play().then(() => { audio.pause(); audio.currentTime = 0; audio.muted = false; }).catch(() => {});
        });
    }

    const CONFIG = {
        maxScore: 1365,
        ranks: [
            { name: "æœ€å¼ºç‹è€…", min: 1298, css: "rank-challenger", color: "#ff3f34" },
            { name: "åè´µç™½é‡‘", min: 957, css: "rank-platinum", color: "#00ced1" },
            { name: "è£è€€é»„é‡‘", min: 547, css: "rank-gold", color: "#f9d423" },
            { name: "ä¸å±ˆç™½é“¶", min: 206, css: "rank-silver", color: "#bdc3c7" },
            { name: "è‹±å‹‡é»„é“œ", min: 0, css: "rank-bronze", color: "#cd7f32" }
        ],
        values: { sign: 3, ask_step: 5, ask_max: 15, feynman: 80, punish_step: 10 },
        autoEval: {
            S: { min: 225, bonus: 20, label: "S" },
            A: { min: 180, bonus: 14, label: "A" },
            B: { min: 120, bonus: 10, label: "B" },
            C: { min: 60, bonus: 6, label: "C" },
            D: { min: -999, bonus: 0, label: "D" }
        },
        tiers: {
            quiz: { max: 60, options: [ { label: "å°æµ‹: 100%", val: 60 }, { label: "å°æµ‹: 90%", val: 54 }, { label: "å°æµ‹: 80%", val: 48 }, { label: "å°æµ‹: 70%", val: 42 }, { label: "å°æµ‹: 60%", val: 36 }, { label: "å°æµ‹: 50%", val: 30 }, { label: "å°æµ‹: <50%", val: 0 } ]},
            hw: { max: 95, options: [ { label: "ä½œä¸š: 100%", val: 95 }, { label: "ä½œä¸š: 90%", val: 86 }, { label: "ä½œä¸š: 80%", val: 76 }, { label: "ä½œä¸š: 70%", val: 67 }, { label: "ä½œä¸š: 60%", val: 57 }, { label: "ä½œä¸š: 50%", val: 48 }, { label: "ä½œä¸š: <50%", val: 0 } ]}
        },
        schedule: { 1: 5, 2: 7, 3: 7, 4: 7, 5: 7 }
    };

    let students = [{ id: 1, name: "æ¼”ç¤ºå­¦å‘˜", scores: {} }]; 
    let currentDay = 1;
    let currentLesson = 1;

    document.addEventListener('DOMContentLoaded', () => {
        updateSchedule();
    });

    function updateSchedule() {
        currentDay = parseInt(document.getElementById('daySelect').value);
        const lessonSelect = document.getElementById('lessonSelect');
        const maxLessons = CONFIG.schedule[currentDay];
        
        lessonSelect.innerHTML = '';
        for (let i = 1; i <= maxLessons; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = `ç¬¬ ${i} å ‚è¯¾`;
            lessonSelect.appendChild(opt);
        }
        currentLesson = 1; 
        manualSortAndRender(); 
    }

    function findStudent(id) { return students.find(s => s.id === id); }

    function ensureData(s) {
        if(!s.scores[currentDay]) s.scores[currentDay] = {};
        if(!s.scores[currentDay][currentLesson]) s.scores[currentDay][currentLesson] = {};
        return s.scores[currentDay][currentLesson];
    }

    // --- åˆ†æ•°è®¡ç®— ---
    function getLessonRawScore(s, d, l) {
        if (!s.scores[d] || !s.scores[d][l]) return 0;
        const data = s.scores[d][l];
        return (data.sign||0) + (data.ask||0) + (data.quiz||0) + (data.hw||0) + (data.feynman||0) - (data.punish||0);
    }

    function getDayRawTotal(s, d) {
        let total = 0;
        const maxL = CONFIG.schedule[d];
        for(let l=1; l<=maxL; l++) { total += getLessonRawScore(s, d, l); }
        return total;
    }

    function getDayFinalScore(s, d) {
        const raw = getDayRawTotal(s, d);
        return raw + getAutoGrade(raw).bonus;
    }

    function getCampTotal(s) {
        let total = 0;
        for(let d=1; d<=5; d++) { total += getDayFinalScore(s, d); }
        return Math.max(0, total);
    }

    function getAutoGrade(netScore) {
        if (netScore >= CONFIG.autoEval.S.min) return CONFIG.autoEval.S;
        if (netScore >= CONFIG.autoEval.A.min) return CONFIG.autoEval.A;
        if (netScore >= CONFIG.autoEval.B.min) return CONFIG.autoEval.B;
        if (netScore >= CONFIG.autoEval.C.min) return CONFIG.autoEval.C;
        return CONFIG.autoEval.D;
    }

    function getRank(score) {
        return CONFIG.ranks.find(r => score >= r.min) || CONFIG.ranks[CONFIG.ranks.length-1];
    }

    function tryPlayAudio(id) {
        const el = document.getElementById(id);
        if(el) { el.currentTime=0; el.play().catch(e=>console.log("Audio Error:", e)); }
    }

    function startBattle() {
        createDanmu("âš”ï¸ THE BATTLE HAS BEGUN!", "#ff3f34");
        confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
        tryPlayAudio('audio-start');
    }

    function checkRankUp(s, oldTotal) {
        const newTotal = getCampTotal(s);
        const oldRank = getRank(oldTotal);
        const newRank = getRank(newTotal);
        if (newRank.min > oldRank.min) {
            createDanmu(`ğŸ‰ æ­å–œ [${s.name}] æ™‹å‡ ã€${newRank.name}ã€‘!`, newRank.color);
            tryPlayAudio('audio-rankup'); 
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: [newRank.color, '#fff'] });
        }
    }

    // --- ç»“ç®—é€»è¾‘ ---
    // 1. æœ¬å ‚ MVP
    function showLessonMVP() {
        currentLesson = parseInt(document.getElementById('lessonSelect').value);
        let max = -9999, mvp = null;
        students.forEach(s => {
            const val = getLessonRawScore(s, currentDay, currentLesson);
            if(val > max && val > 0) { max = val; mvp = s; }
        });
        
        if(mvp) {
            document.getElementById('fmvp-streak').style.display = 'none';
            showOverlay("ğŸ… æœ¬å ‚ MVP", mvp.name, `æœ¬èŠ‚å¾—åˆ†: ${max}`, false);
            tryPlayAudio('audio-victory');
            confetti({ particleCount: 150, colors: ['#f9d423', '#fff'] });
        } else { alert("æœ¬å ‚è¯¾æš‚æ— æ•°æ®!"); }
    }

    // 2. æœ¬æ—¥å† å†› (Daily MVP)
    function showDailyMVP() {
        let max = -9999, fmvp = null;
        students.forEach(s => {
            const val = getDayFinalScore(s, currentDay);
            if(val > max && val > 0) { max = val; fmvp = s; }
        });

        if(fmvp) {
            // è¿å† é€»è¾‘
            let stats = JSON.parse(localStorage.getItem('fmvp_streak') || '{}');
            let streak = (stats[fmvp.name] || 0) + 1;
            stats[fmvp.name] = streak;
            localStorage.setItem('fmvp_streak', JSON.stringify(stats));

            let snd = 'audio-fmvp-1', txt = "ğŸ† FMVP: UNSTOPPABLE!";
            if(streak===2) { snd='audio-fmvp-2'; txt="âœŒï¸ 2è¿å† : KILLING SPREE!"; }
            else if(streak===3) { snd='audio-fmvp-3'; txt="ğŸ”¥ 3è¿å† : RAMPAGE!"; }
            else if(streak===4) { snd='audio-fmvp-4'; txt="ğŸ‘‘ 4è¿å† : DOMINATING!"; }
            else if(streak>=5) { snd='audio-fmvp-5'; txt="ğŸ‰ 5+è¿å† : LEGENDARY!"; }

            document.getElementById('fmvp-streak').innerText = txt;
            document.getElementById('fmvp-streak').style.display = 'block';
            
            showOverlay("ğŸ“… æœ¬æ—¥å† å†›", fmvp.name, `ä»Šæ—¥æ€»åˆ†: ${max}`, true);
            tryPlayAudio(snd);
            confetti({ particleCount: 300, spread: 150, colors: ['#2ecc71', '#f9d423'] });
        } else { alert("æœ¬æ—¥æš‚æ— æ•°æ®!"); }
    }

    // 3. æ€»å†³èµ› FMVP (Grand FMVP)
    function showGrandFMVP() {
        let max = -9999, grand = null;
        students.forEach(s => {
            const val = getCampTotal(s);
            if(val > max && val > 0) { max = val; grand = s; }
        });

        if(grand) {
            document.getElementById('fmvp-streak').style.display = 'none';
            showOverlay("ğŸ‘‘ æ€»å†³èµ› FMVP", grand.name, `æ€»ç§¯åˆ†: ${max}`, true);
            tryPlayAudio('audio-legendary');
            let end = Date.now() + 3000;
            (function f(){
                confetti({ particleCount: 10, spread: 60, origin:{x:Math.random(), y:0.5} });
                if(Date.now()<end) requestAnimationFrame(f);
            })();
        }
    }

    function showOverlay(title, name, score, isFmvp) {
        const el = document.getElementById('mvp-overlay');
        document.getElementById('mvp-title').innerText = title;
        document.getElementById('mvp-name').innerText = name;
        document.getElementById('mvp-score').innerText = score;
        if(isFmvp) el.classList.add('fmvp-style'); else el.classList.remove('fmvp-style');
        el.classList.add('active');
    }

    function toggleBtn(id, field) {
        let s = findStudent(id); if (!s) return;
        const oldTotal = getCampTotal(s);
        let d = ensureData(s);
        const name = s.name;

        if (field === 'sign') {
            if (d.sign === CONFIG.values.sign) d.sign = 0;
            else { d.sign = CONFIG.values.sign; createDanmu(`ğŸš€ [${name}] å‡†å¤‡å‡ºå‡»!`, "#00ff00"); tryPlayAudio('audio-minions'); }
        } 
        else if (field === 'ask') {
            const val = d.ask || 0;
            if (val === 0) { d.ask = 5; tryPlayAudio('audio-firstblood'); createDanmu(`ğŸ©¸ FIRST BLOOD! [${name}]`, "#ff0000"); }
            else if (val === 5) { d.ask = 10; tryPlayAudio('audio-doublekill'); createDanmu(`âœŒï¸ DOUBLE KILL! [${name}]`, "#ff4500"); }
            else if (val === 10) { d.ask = 15; tryPlayAudio('audio-triplekill'); createDanmu(`ğŸ”¥ TRIPLE KILL! [${name}]`, "#ff00ff"); confetti({particleCount:50, spread:60, origin:{y:0.7}}); }
            else { d.ask = 0; }
        }
        else if (field === 'feynman') {
            if (d.feynman === CONFIG.values.feynman) d.feynman = 0;
            else { d.feynman = CONFIG.values.feynman; confetti({particleCount:50, origin:{y:0.7}}); }
        }
        
        checkRankUp(s, oldTotal);
        renderGrid(); 
    }

    function updateSelect(id, field, val) {
        let s = findStudent(id); if(!s) return;
        const oldTotal = getCampTotal(s);
        let d = ensureData(s);
        d[field] = parseInt(val);
        checkRankUp(s, oldTotal);
        renderGrid();
    }

    function addPunish(id) {
        let s = findStudent(id); if(!s) return;
        let d = ensureData(s);
        d.punish = (d.punish || 0) + CONFIG.values.punish_step;
        const count = d.punish / CONFIG.values.punish_step;
        const name = s.name;
        
        if(count===1) { tryPlayAudio('snd-p1'); createDanmu(`âš ï¸ Disconnected! [${name}]`, "#7f8c8d"); }
        else if(count===2) { tryPlayAudio('snd-p2'); createDanmu(`ğŸ›¡ï¸ Inhibitor Attack! [${name}]`, "#e67e22"); }
        else if(count===3) { tryPlayAudio('snd-p3'); createDanmu(`ğŸ’€ Slain! [${name}]`, "#c0392b"); }
        else if(count>=4) { tryPlayAudio('snd-p4'); createDanmu(`ğŸ³ï¸ DEFEAT! [${name}]`, "#2c3e50"); }
        renderGrid();
    }

    function createDanmu(text, color) {
        const d = document.createElement('div');
        d.className = 'danmu'; d.innerText = text; d.style.color = color || '#fff';
        d.style.top = (20 + Math.random() * 60) + '%';
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 8000);
    }

    function addStudent() {
        const name = prompt("å­¦å‘˜å§“å:");
        if(name) { students.push({ id: Date.now(), name: name, scores: {} }); manualSortAndRender(); }
    }

    function manualSortAndRender() {
        students.sort((a, b) => getCampTotal(b) - getCampTotal(a));
        renderGrid();
    }

    function getRank(score) {
        return CONFIG.ranks.find(r => score >= r.min) || CONFIG.ranks[CONFIG.ranks.length-1];
    }

    function renderGrid() {
        currentLesson = parseInt(document.getElementById('lessonSelect').value);
        const maxLessons = CONFIG.schedule[currentDay];
        
        // æ™ºèƒ½æ˜¾ç¤ºæ§åˆ¶
        const btnDayMvp = document.querySelector('.btn-day-mvp');
        const btnGrandFmvp = document.querySelector('.btn-grand-fmvp');
        
        // é€»è¾‘ï¼šæœ¬æ—¥å† å†›ä»…åœ¨æœ¬æ—¥æœ€åä¸€å ‚è¯¾æ˜¾ç¤º
        if (currentLesson === maxLessons) {
            btnDayMvp.style.display = 'flex';
        } else {
            btnDayMvp.style.display = 'none';
        }

        // é€»è¾‘ï¼šæ€»å†³èµ›FMVPä»…åœ¨ Day 5 çš„æœ€åä¸€å ‚è¯¾æ˜¾ç¤º
        if (currentDay === 5 && currentLesson === 7) {
            btnGrandFmvp.style.display = 'flex';
        } else {
            btnGrandFmvp.style.display = 'none';
        }

        const grid = document.getElementById('studentGrid');
        grid.innerHTML = '';
        
        students.forEach((student) => {
            const d = student.scores[currentDay] && student.scores[currentDay][currentLesson] ? student.scores[currentDay][currentLesson] : {};
            const dayRaw = getDayRawTotal(student, currentDay);
            const gradeInfo = getAutoGrade(dayRaw);
            const campTotal = getCampTotal(student);
            const rank = getRank(campTotal);

            const signCls = d.sign ? 'active' : '';
            const feynCls = d.feynman ? 'active' : '';
            let askCls = '';
            if (d.ask === 5) askCls = 'active stage-1'; else if (d.ask === 10) askCls = 'active stage-2'; else if (d.ask === 15) askCls = 'active stage-3';

            const card = document.createElement('div');
            card.className = `card ${rank.css}`;
            card.innerHTML = `
                <div class="card-header">
                    <div class="user-info">
                        <div class="avatar" style="border-color:${rank.color}">${student.name[0]}</div>
                        <div>
                            <div style="font-weight:bold; color:#fff">${student.name}</div>
                            <div style="font-size:0.8rem; color:${rank.color}">${rank.name}</div>
                        </div>
                    </div>
                    <div class="score-badge">
                        <div class="total-at">${campTotal}</div>
                        <div class="sub-score">æ€»ç§¯åˆ†</div>
                    </div>
                </div>

                <div class="auto-eval-bar">
                    <div class="eval-left">
                        <div>ä»Šæ—¥å‡€åˆ†: <span style="color:#fff">${dayRaw}</span></div>
                        <div style="font-size:0.7rem">ç³»ç»Ÿè¯„çº§: <span class="grade-${gradeInfo.label}" style="font-weight:bold">${gradeInfo.label} (+${gradeInfo.bonus})</span></div>
                    </div>
                    <div class="eval-right" style="text-align:right">
                        <div style="font-size:0.7rem; color:#888">æœ¬èŠ‚å¾—åˆ†</div>
                        <div style="font-weight:bold; color:#fff">${(d.sign||0)+(d.ask||0)+(d.quiz||0)+(d.hw||0)+(d.feynman||0)-(d.punish||0)}</div>
                    </div>
                </div>

                <div class="actions-area">
                    <div class="skill-btn ${signCls}" onclick="toggleBtn(${student.id}, 'sign')">
                        <div class="label">ç­¾åˆ°</div><div class="value">+${CONFIG.values.sign}</div>
                    </div>
                    <div class="skill-btn ask-btn ${askCls}" onclick="toggleBtn(${student.id}, 'ask')">
                        <div class="label">äº’åŠ¨</div><div class="value">${d.ask||0}/15</div>
                    </div>
                    <div class="select-container ${d.quiz > 0 ? 'has-value' : ''}">
                        <select onchange="updateSelect(${student.id}, 'quiz', this.value)">
                            <option value="0" ${!d.quiz ? 'selected' : ''}>å°æµ‹ (æœªå½•å…¥)</option>
                            ${CONFIG.tiers.quiz.options.map(o => `<option value="${o.val}" ${d.quiz===o.val?'selected':''}>${o.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="select-container ${d.hw > 0 ? 'has-value' : ''}">
                        <select onchange="updateSelect(${student.id}, 'hw', this.value)">
                            <option value="0" ${!d.hw ? 'selected' : ''}>ä½œä¸š (æœªå½•å…¥)</option>
                            ${CONFIG.tiers.hw.options.map(o => `<option value="${o.val}" ${d.hw===o.val?'selected':''}>${o.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="skill-btn feynman-btn ${feynCls}" onclick="toggleBtn(${student.id}, 'feynman')">
                        <div class="label">â˜… è´¹æ›¼æŠ€å·§</div><div class="value">+${CONFIG.values.feynman}</div>
                    </div>
                    <div class="skill-btn punish-btn" onclick="addPunish(${student.id})">
                        <div class="label">âš ï¸ è¿çºª/æœªå®Œæˆ (ç‚¹å‡»å åŠ )</div>
                        <div class="punish-val">-${d.punish||0}</div>
                    </div>
                </div>
                <div class="progress-track"><div class="progress-bar" style="width: ${(campTotal/CONFIG.maxScore)*100}%; background:${rank.color}"></div></div>
            `;
            grid.appendChild(card);
        });
    }
</script>
</body>
</html>